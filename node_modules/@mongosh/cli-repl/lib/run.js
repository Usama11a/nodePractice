"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const index_1 = require("./index");
const service_provider_server_1 = require("@mongosh/service-provider-server");
(async () => {
    let repl;
    try {
        const options = index_1.parseCliArgs(process.argv);
        const { version } = require('../package.json');
        if (options.help) {
            console.log(index_1.USAGE);
        }
        else if (options.version) {
            console.log(version);
        }
        else if (options.smokeTests) {
            const smokeTestServer = process.env.MONGOSH_SMOKE_TEST_SERVER;
            if (process.execPath === process.argv[1]) {
                await index_1.runSmokeTests(smokeTestServer, process.execPath);
            }
            else {
                await index_1.runSmokeTests(smokeTestServer, process.execPath, process.argv[1]);
            }
        }
        else {
            let mongocryptdSpawnPaths = [['mongocryptd']];
            if (process.execPath === process.argv[1]) {
                process.removeAllListeners('warning');
                mongocryptdSpawnPaths = await index_1.getMongocryptdPaths();
            }
            if (process.env.CLEAR_SIGINT_LISTENERS) {
                process.removeAllListeners('SIGINT');
            }
            process.title = 'mongosh';
            const driverOptions = await index_1.mapCliToDriver(options);
            const driverUri = service_provider_server_1.generateUri(options);
            const appName = `${process.title} ${version}`;
            const shellHomePaths = index_1.getStoragePaths();
            repl = new index_1.CliRepl({
                shellCliOptions: {
                    ...options,
                },
                mongocryptdSpawnPaths,
                input: process.stdin,
                output: process.stdout,
                onExit: process.exit,
                shellHomePaths: shellHomePaths
            });
            await repl.start(driverUri, { appName, ...driverOptions });
        }
    }
    catch (e) {
        console.error(`${e.name}: ${e.message}`);
        if (repl !== undefined) {
            repl.bus.emit('mongosh:error', e);
        }
        process.exit(1);
    }
})();
//# sourceMappingURL=run.js.map